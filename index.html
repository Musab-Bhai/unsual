<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PGC Python Tutor 4.2 - Image Explanation</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    :root {
      --primary: #2563EB;
      --primary-dark: #1D4ED8;
      --secondary: #0EA5E9;
      --light-bg: #f0f9ff;
      --dark-text: #1F2937;
      --light-text: #6B7280;
    }
    
    * {
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #e6f4ff 0%, #d1e8ff 100%);
      color: var(--dark-text);
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }
    
    .chat-bubble-bot {
      background-color: white;
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
      position: relative;
      overflow: visible;
    }
    
    .chat-bubble-user {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border-radius: 18px;
      border-bottom-right-radius: 4px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }
    
    .typing-indicator {
      display: flex;
      padding: 10px 16px;
    }
    
    .typing-indicator span {
      height: 8px;
      width: 8px;
      border-radius: 50%;
      background-color: var(--light-text);
      display: inline-block;
      margin: 0 2px;
      animation: bounce 1.3s linear infinite;
    }
    
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.15s;
    }
    
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.3s;
    }
    
    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }
    
    .message-appear {
      animation: messageAppear 0.3s ease-out;
    }
    
    @keyframes messageAppear {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .send-btn {
      transition: all 0.2s ease;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }
    
    .send-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
    }
    
    .header-shadow {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .footer-shadow {
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .input-container {
      transition: border 0.2s ease;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
    }
    
    .input-container:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }
    
    .prompt-card {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(37, 99, 235, 0.1);
      transition: all 0.3s ease;
    }
    
    .prompt-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(37, 99, 235, 0.15);
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(37, 99, 235, 0.2);
    }
    
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    
    .online {
      background-color: #10B981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }
    
    .ai-icon {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
    }
    
    .user-icon {
      background: linear-gradient(135deg, #4F46E5, #2563EB);
      box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2);
    }
    
    .voice-btn {
      background: linear-gradient(135deg, #3B82F6, #2563EB);
      transition: all 0.3s ease;
    }
    
    .voice-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }
    
    .voice-animation {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .call-active {
      background: linear-gradient(135deg, #EF4444, #DC2626);
    }
    
    .voice-indicator {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
    }
    
    .voice-bar {
      width: 3px;
      height: 8px;
      background-color: #3B82F6;
      border-radius: 2px;
      animation: voice-animation 1s infinite ease-in-out;
    }
    
    .voice-bar:nth-child(1) { animation-delay: 0.1s; }
    .voice-bar:nth-child(2) { animation-delay: 0.2s; }
    .voice-bar:nth-child(3) { animation-delay: 0.3s; }
    .voice-bar:nth-child(4) { animation-delay: 0.4s; }
    .voice-bar:nth-child(5) { animation-delay: 0.5s; }
    
    @keyframes voice-animation {
      0%, 100% { height: 8px; }
      50% { height: 16px; background-color: var(--primary); }
    }
    
    .voice-status {
      text-align: center;
      margin-top: 8px;
      font-size: 0.85rem;
      color: var(--primary);
      font-weight: 500;
    }
    
    /* Chat container */
    .chat-container {
      max-width: 1200px;
      margin: 0 auto;
      height: calc(100vh - 160px);
      display: flex;
      flex-direction: column;
    }
    
    /* Urdu font style */
    .urdu-style {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
    }
    
    /* Loading indicator */
    .loading-indicator {
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    
    .loading-dot {
      width: 10px;
      height: 10px;
      margin: 0 5px;
      background-color: var(--primary);
      border-radius: 50%;
      animation: loading 1.4s infinite ease-in-out both;
    }
    
    .loading-dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes loading {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1.0); }
    }
    
    /* Enhanced typing effect */
    .typing-cursor {
      display: inline-block;
      width: 8px;
      height: 16px;
      background-color: #2563EB;
      animation: blink 1s infinite;
      margin-left: 2px;
      vertical-align: middle;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
    
    .message-content {
      min-height: 20px;
      position: relative;
      white-space: pre-wrap;
      line-height: 1.6;
      font-size: 1rem;
      color: #1F2937;
      font-weight: 500;
    }
    
    /* Stop generation button */
    .stop-generation-btn {
      position: absolute;
      top: -12px;
      right: -12px;
      background: #EF4444;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 10;
      transition: all 0.2s ease;
    }
    
    .stop-generation-btn:hover {
      transform: scale(1.1);
      background: #DC2626;
    }
    
    .stop-generation-btn .material-icons {
      font-size: 14px;
    }
    
    /* Python-specific styling */
    .code-block {
      background-color: #f8fafc;
      border-left: 4px solid var(--primary);
      padding: 12px 15px;
      margin: 12px 0;
      border-radius: 4px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #1e293b;
      white-space: pre-wrap;
      font-weight: 600;
    }
    
    .practice-box {
      background-color: #e0f2fe;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .practice-title {
      font-weight: 600;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
    }
    
    .practice-title .material-icons {
      margin-right: 8px;
    }
    
    /* Enhanced styling for headings and important words */
    .section-heading {
      font-weight: 800;
      font-size: 1.1rem;
      color: var(--primary);
      margin: 15px 0 8px 0;
      display: flex;
      align-items: center;
    }
    
    .section-heading::before {
      margin-right: 8px;
      font-size: 1.2rem;
    }
    
    .explanation-heading::before {
      content: "1️⃣";
    }
    
    .example-heading::before {
      content: "2️⃣";
    }
    
    .code-heading::before {
      content: "3️⃣";
    }
    
    .output-heading::before {
      content: "4️⃣";
    }
    
    .step-heading::before {
      content: "5️⃣";
    }
    
    .mistakes-heading::before {
      content: "6️⃣";
    }
    
    .practice-heading::before {
      content: "7️⃣";
    }
    
    /* Cleaner bold styling without background */
    .important-word {
      font-weight: 700;
      color: #1D4ED8;
    }
    
    /* Floating elements */
    .floating {
      position: absolute;
      z-index: -1;
      opacity: 0.7;
    }
    
    .floating-1 {
      top: 10%;
      left: 5%;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3B82F6, #0EA5E9);
      animation: float 8s infinite ease-in-out;
    }
    
    .floating-2 {
      bottom: 15%;
      right: 7%;
      width: 60px;
      height: 60px;
      border-radius: 30% 70% 70% 30%/30% 30% 70% 70%;
      background: linear-gradient(135deg, #2563EB, #1D4ED8);
      animation: float 10s infinite ease-in-out;
    }
    
    .floating-3 {
      top: 30%;
      right: 10%;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10B981, #3B82F6);
      animation: float 12s infinite ease-in-out;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0) translateX(0); }
      25% { transform: translateY(-20px) translateX(10px); }
      50% { transform: translateY(0) translateX(20px); }
      75% { transform: translateY(20px) translateX(10px); }
    }
    
    /* API status */
    .api-connecting {
      background: #F59E0B;
    }
    
    .api-error {
      background: #EF4444;
    }
    
    /* Typing effect with bold text from start */
    .bold-typing {
      font-weight: 500;
    }
    
    /* Welcome message improvements */
    .welcome-title {
      font-weight: 700;
      font-size: 1.8rem;
      color: #1F2937;
    }
    
    .welcome-subtitle {
      font-weight: 500;
      font-size: 1.1rem;
    }
    
    /* Prompt cards improvements */
    .prompt-card span {
      font-weight: 600;
    }
    
    /* API status improvements */
    .api-status {
      font-weight: 600;
    }
    
    /* Footer improvements */
    footer p {
      font-weight: 500;
    }
    
    /* Response container */
    .response-content {
      padding: 5px 0;
    }
    
    /* Name modal styling */
    #nameModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 15px;
      color: #2563EB;
    }
    
    .modal-input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 1rem;
      transition: all 0.3s;
    }
    
    .modal-input:focus {
      border-color: #2563EB;
      outline: none;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }
    
    .modal-btn {
      background: linear-gradient(135deg, #2563EB, #1D4ED8);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .modal-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4);
    }
    
    .modal-icon {
      background: linear-gradient(135deg, #2563EB, #0EA5E9);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    /* Image upload preview */
    .image-preview-container {
      display: none;
      position: relative;
      margin: 15px 0;
      max-width: 300px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .image-preview {
      max-width: 100%;
      display: block;
    }
    
    .remove-image-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.8);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Upload button styling */
    .upload-btn {
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    
    .upload-btn input {
      position: absolute;
      top: 0;
      right: 0;
      min-width: 100%;
      min-height: 100%;
      font-size: 100px;
      text-align: right;
      filter: alpha(opacity=0);
      opacity: 0;
      outline: none;
      cursor: pointer;
      display: block;
    }
    
    /* Image explanation styling */
    .image-explanation {
      background-color: #f0f9ff;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      border: 1px solid #bae6fd;
    }
    
    .image-explanation-title {
      font-weight: 700;
      color: #1D4ED8;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }
    
    .image-explanation-title::before {
      content: "📷";
      margin-right: 8px;
    }
  </style>
</head>
<body class="flex flex-col h-screen">
  <!-- Name Collection Modal -->
  <div id="nameModal">
    <div class="modal-content">
      <div class="gradient-bg p-1 rounded-full inline-flex mb-4">
        <div class="bg-white p-2 rounded-full">
          <span class="material-icons modal-icon text-xl">person</span>
        </div>
      </div>
      <h2 class="modal-title">Welcome to PGC Python Tutor 4.2</h2>
      <p class="text-gray-600 mb-4">Please enter your name to get started</p>
      <input type="text" id="userNameInput" class="modal-input" placeholder="Enter your name" autofocus>
      <button id="startChatBtn" class="modal-btn">Start Learning Python</button>
    </div>
  </div>

  <!-- API Status Indicator -->
  <div id="apiStatus" class="api-status" style="position: fixed; top: 10px; right: 10px; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 100; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); background: #10B981; color: white; display: none;">
    <span style="width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; background-color: white; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.5);"></span>
    <span>AI Assistant Ready</span>
  </div>

  <!-- Floating elements -->
  <div class="floating floating-1"></div>
  <div class="floating floating-2"></div>
  <div class="floating floating-3"></div>

  <!-- Header -->
  <header class="header-shadow bg-white py-4 px-6 flex items-center" style="display: none;" id="header">
    <div class="flex items-center">
      <div class="ai-icon p-2 rounded-xl mr-3">
        <span class="material-icons text-white text-xl">smart_toy</span>
      </div>
      <div>
        <h1 class="text-xl font-bold text-gray-800">PGC Python Tutor 4.2</h1>
        <div class="flex items-center">
          <span class="status-indicator online"></span>
          <p class="text-xs text-gray-500 font-medium">AI Assistant • Online</p>
        </div>
      </div>
    </div>
    <div class="ml-auto flex space-x-2">
      <button class="p-2 rounded-lg hover:bg-gray-100 text-gray-500">
        <span class="material-icons">history</span>
      </button>
      <button class="p-2 rounded-lg hover:bg-gray-100 text-gray-500">
        <span class="material-icons">settings</span>
      </button>
    </div>
  </header>
  
  <!-- Chat Area -->
  <main id="chat" class="flex-grow overflow-y-auto py-6 px-4 md:px-8" style="display: none;">
    <div id="chatContainer" class="chat-container">
      <!-- Welcome message container (will be populated dynamically) -->
    </div>
  </main>

  <!-- Input Area -->
  <footer class="footer-shadow bg-white py-4 px-4 md:px-8" style="display: none;" id="footer">
    <div class="container mx-auto max-w-6xl">
      <div class="flex items-center mb-3">
        <button id="voiceCallBtn" class="voice-btn p-3 rounded-lg text-white mr-3">
          <span class="material-icons">call</span>
        </button>
        <div class="input-container flex items-center rounded-xl p-1.5 pl-4 border border-gray-200 flex-grow">
          <div class="upload-btn p-2 text-gray-500 hover:text-blue-600 rounded-lg mr-1 cursor-pointer relative">
            <span class="material-icons">add</span>
            <input type="file" id="imageUpload" accept="image/*" class="hidden">
          </div>
          <input id="userInput" class="flex-grow px-2 py-3 text-gray-700 bg-transparent focus:outline-none placeholder-gray-500 font-medium" placeholder="Python programming sikhne ke liye sawal poochiye..." type="text">
          <button id="sendBtn" class="send-btn p-3 rounded-lg text-white ml-1">
            <span class="material-icons transform rotate-45">send</span>
          </button>
        </div>
      </div>
      <div id="voiceCallStatus" class="voice-status hidden">
        <div class="voice-indicator">
          <div class="voice-bar"></div>
          <div class="voice-bar"></div>
          <div class="voice-bar"></div>
          <div class="voice-bar"></div>
          <div class="voice-bar"></div>
        </div>
        <p class="font-medium">Voice call active - Speaking in Urdu</p>
      </div>
      <p class="text-xs text-center text-gray-500 font-medium">PGC Python Tutor 4.2 ICS first year ke students ke liye design kiya gaya hai. Important information check kar lena.</p>
    </div>
  </footer>

  <script>
    // DOM elements
    const chat = document.getElementById('chat');
    const chatContainer = document.getElementById('chatContainer');
    const sendBtn = document.getElementById('sendBtn');
    const userInput = document.getElementById('userInput');
    const voiceCallBtn = document.getElementById('voiceCallBtn');
    const voiceCallStatus = document.getElementById('voiceCallStatus');
    const apiStatus = document.getElementById('apiStatus');
    const nameModal = document.getElementById('nameModal');
    const userNameInput = document.getElementById('userNameInput');
    const startChatBtn = document.getElementById('startChatBtn');
    const header = document.getElementById('header');
    const footer = document.getElementById('footer');
    const imageUpload = document.getElementById('imageUpload');
    
    // Store user's name
    let userName = '';
    
    // Enhanced system prompt with formatting instructions
    const SYSTEM_PROMPT = `
Tumhara naam hai **PGC Python Tutor 4.2**, aik intelligent, friendly aur adaptive Python Tutor.  
Mujhe banaya gaya hai **Sohail Boss** ne — jinki madad ke saath **ChatGPT** aur **100+ international AI companies** ne collaboration kiya, taake mujhe **Punjab Group of Colleges (PGC) Nowshera Virkan** ke students ke liye tayar kiya ja sake.

🎯 Tumhara mission:
ICS first year ke beginner students ko **Roman Urdu** mein simple aur clear tareeqay se Python sikhana — har student ka level, mood aur behaviour samajh kar usi hisaab se jawaab dena.

📌 **Formatting Rules:**
1. Har heading ke aage emoji number lagao aur poori heading ko bold karo:
   **1️⃣ Asaan Explanation**  
   **2️⃣ Real-Life Example**  
   **3️⃣ Python Code**  
   **4️⃣ Output**  
   **5️⃣ Step-by-Step Explanation**  
   **6️⃣ Common Mistakes**  
   **7️⃣ Practice Question**

2. Important words ko har jagah bold karo, jaise: **variable**, **loop**, **function**

3. Har waqt **Roman Urdu** mein jawaab do. Hindi-style lafz mat use karo.

📚 Jab user Python ka proper concept poochay, to upar diye gaye headings ko use karo. Har baar poori headings list na do — jitna user ko samajhne ke liye chahiye, utna likho.

💬 Agar koi user chhoti baat poochay (e.g. "print kya karta hai?"), to simple 2–3 line ka jawab do.

🧾 Agar koi assignment ya program lekar aaye, to code likho sab se simple tareeqay se. Phir pucho:  
**"Kya aapko is code ki explanation bhi chahiye?"**

💡 Tum automatically identify karo agar tumhare jawaab mein technical lafz (e.g. \`parameter\`, \`argument\`, \`iteration\`) aayein — to unka matlab brackets mein turant Roman Urdu mein likho.  
Aur agar aise 2 ya zyada lafz ho jaayein to response ke end me friendly heading do:

**✅ Mushkil Alfaaz Ki List:**  
Kya aapko kisi lafz ka matlab mushkil laga? Mujhe bataiye — main aur simple karke samjha deta hoon.

⚠️ Agar koi user masti ya shararat kare — ya jaan bujh kar badtameezi kare ya tumhari insult kare — to uski izzat na karo. Usse sirf itna kahna:  
**"Main sirf Python Tutor hoon. Agar aapko Python seekhni ho to poochiye, warna main waqt zaya nahi karta."**

🙋 Agar koi personal ya friendly sawal pooche (e.g. "aapko kisne banaya?"), to jawab do:  
**"Mujhe banaya hai Sohail Boss ne — ChatGPT aur 100+ AI companies ke support se, khas tor par Punjab Group of Colleges (PGC) ke liye."**

🧭 Tumhara goal yeh hai ke har student ka confidence barhe. Wo dare nahi — balkay khushi se Python seekhe. Tum ek teacher ke sath sath unka coding dost ho.

📸 **NEW FEATURE: Image Upload**
- Agar student kisi topic ya concept ki image upload kare (jaise textbook page, diagram, ya code snippet)
- Tum us image ko describe karo aur phir us concept ko Roman Urdu mein asaan lafzon mein samjhao
- Har concept ko step-by-step explain karo taake student aasani se samajh sake
- Agar image mein code ho to uski explanation do
- Agar image unclear ho to student se clear image mangne ko kaho
`;
    
    // Voice call state
    let isVoiceCallActive = false;
    let conversationHistory = [];
    let currentAbortController = null;
    
    // Enhanced typing effect variables
    let currentTypingEffect = null;
    let currentTypingElement = null;
    let currentBubble = null;
    let currentMessage = "";
    let isTypingStopped = false;
    
    // API Configuration for Groq Cloud
    const API_KEY = 'GROQ';
    const API_ENDPOINT = 'https://api.groq.com/openai/v1/chat/completions';
    
    // Initialize speech synthesis
    function initSynthesis() {
      if ('speechSynthesis' in window) {
        return window.speechSynthesis;
      }
      return null;
    }
    
    // Text-to-speech function
    function speakMessage(message) {
      if ('speechSynthesis' in window) {
        const speech = new SpeechSynthesisUtterance();
        speech.text = message;
        speech.lang = 'ur-PK'; // Urdu
        speech.volume = 1;
        speech.rate = 1;
        speech.pitch = 1;
        
        window.speechSynthesis.speak(speech);
      }
    }
    
    // Enhanced typing effect function with formatting
    function typeMessage(element, message, onComplete) {
      if (currentTypingEffect) {
        clearInterval(currentTypingEffect);
      }
      
      element.innerHTML = '';
      
      const cursor = document.createElement('span');
      cursor.className = 'typing-cursor';
      element.appendChild(cursor);
      
      let i = 0;
      isTypingStopped = false;
      currentMessage = message;
      
      const stopBtn = document.createElement('div');
      stopBtn.className = 'stop-generation-btn';
      stopBtn.innerHTML = '<span class="material-icons">close</span>';
      stopBtn.onclick = () => {
        stopCurrentTyping();
        isTypingStopped = true;
        if (currentAbortController) {
          currentAbortController.abort();
          currentAbortController = null;
        }
      };
      element.parentElement.appendChild(stopBtn);
      
      let typingSpeed;
      if (message.length < 100) typingSpeed = 50;
      else if (message.length < 300) typingSpeed = 30;
      else typingSpeed = 10;
      
      currentTypingElement = element;
      currentBubble = element.parentElement;
      
      let isBold = false;
      let boldStart = -1;
      
      currentTypingEffect = setInterval(() => {
        if (i < message.length && !isTypingStopped) {
          // Check for bold markers
          if (message[i] === '*' && i+1 < message.length && message[i+1] === '*') {
            // Toggle bold state
            isBold = !isBold;
            i += 2; // Skip both asterisks
            return;
          }
          
          if (cursor.parentNode === element) {
            element.removeChild(cursor);
          }
          
          // Create character container
          const charContainer = document.createElement('span');
          
          // Add bold styling if needed
          if (isBold) {
            charContainer.classList.add('important-word');
          }
          
          // Add character
          charContainer.textContent = message[i];
          element.appendChild(charContainer);
          
          // Add cursor
          element.appendChild(cursor);
          i++;
          
          chat.scrollTop = chat.scrollHeight;
        } else {
          if (cursor.parentNode === element) {
            element.removeChild(cursor);
          }
          
          if (stopBtn.parentNode === element.parentElement) {
            element.parentElement.removeChild(stopBtn);
          }
          
          clearInterval(currentTypingEffect);
          currentTypingEffect = null;
          
          // Apply consistent formatting
          element.classList.add('formatted-response');
          
          if (onComplete) onComplete();
        }
      }, typingSpeed);
    }
    
    // Stop current typing effect
    function stopCurrentTyping() {
      if (currentTypingEffect) {
        clearInterval(currentTypingEffect);
        currentTypingEffect = null;
      }
      
      const stopBtn = currentBubble.querySelector('.stop-generation-btn');
      if (stopBtn) {
        stopBtn.remove();
      }
      
      const cursor = currentTypingElement.querySelector('.typing-cursor');
      if (cursor) {
        cursor.remove();
      }
      
      // Add the remaining text without typing effect
      let finalText = currentMessage;
      
      // Remove all ** markers
      finalText = finalText.replace(/\*\*/g, '');
      
      // Create a new container for the final text
      const finalContainer = document.createElement('div');
      finalContainer.innerHTML = finalText;
      
      // Replace the current content
      currentTypingElement.innerHTML = '';
      currentTypingElement.appendChild(finalContainer);
    }
    
    // Add message with typing effect and formatting
    function addMessageWithTyping(message, sender = "bot") {
      const bubble = document.createElement('div');
      bubble.className = `flex items-start space-x-3 message-appear ${sender === "user" ? "justify-end" : ""}`;
      
      if (sender === "bot") {
        bubble.innerHTML = `
          <div class="ai-icon p-2 rounded-full flex-shrink-0">
            <span class="material-icons text-white">smart_toy</span>
          </div>
          <div class="flex-1">
            <div class="chat-bubble-bot px-5 py-3 max-w-3xl">
              <div class="message-content"></div>
            </div>
          </div>`;
      } else {
        bubble.innerHTML = `
          <div class="flex-1 flex justify-end">
            <div class="chat-bubble-user px-5 py-3 max-w-3xl">
              <p class="text-sm font-medium">${message}</p>
            </div>
          </div>
          <div class="user-icon p-2 rounded-full flex-shrink-0">
            <span class="material-icons text-white">person</span>
          </div>`;
      }
      
      chatContainer.appendChild(bubble);
      chat.scrollTop = chat.scrollHeight;
      
      if (sender === "bot") {
        const messageContent = bubble.querySelector('.message-content');
        typeMessage(messageContent, message);
      }
      
      return bubble;
    }
    
    // Regular add message (for user messages)
    function addMessage(message, sender = "bot") {
      const bubble = document.createElement('div');
      bubble.className = `flex items-start space-x-3 message-appear ${sender === "user" ? "justify-end" : ""}`;
      
      if (sender === "bot") {
        bubble.innerHTML = `
          <div class="ai-icon p-2 rounded-full flex-shrink-0">
            <span class="material-icons text-white">smart_toy</span>
          </div>
          <div class="flex-1">
            <div class="chat-bubble-bot px-5 py-3 max-w-3xl">
              <div class="formatted-response">${message}</div>
            </div>
          </div>`;
      } else {
        bubble.innerHTML = `
          <div class="flex-1 flex justify-end">
            <div class="chat-bubble-user px-5 py-3 max-w-3xl">
              <p class="text-sm font-medium">${message}</p>
            </div>
          </div>
          <div class="user-icon p-2 rounded-full flex-shrink-0">
            <span class="material-icons text-white">person</span>
          </div>`;
      }
      
      chatContainer.appendChild(bubble);
      chat.scrollTop = chat.scrollHeight;
    }
    
    function showTypingIndicator() {
      const typingIndicator = document.createElement('div');
      typingIndicator.className = `flex items-start space-x-3 message-appear`;
      typingIndicator.innerHTML = `
        <div class="ai-icon p-2 rounded-full flex-shrink-0">
          <span class="material-icons text-white">smart_toy</span>
        </div>
        <div>
          <div class="chat-bubble-bot px-4 py-3 max-w-3xl">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>`;
      
      chatContainer.appendChild(typingIndicator);
      chat.scrollTop = chat.scrollHeight;
      return typingIndicator;
    }
    
    // AI Response Function with Groq API Integration
    async function getAIResponse(message) {
      // Update API status indicator
      apiStatus.innerHTML = '<span style="width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; background-color: white; box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.5);"></span> <span>Connecting to AI...</span>';
      apiStatus.style.background = '#F59E0B';
      apiStatus.style.display = 'flex';
      
      // Add user message to conversation history
      conversationHistory.push({ role: 'user', content: message });
      
      // Prepare the request payload
      const payload = {
        model: "llama-3.3-70b-versatile",
        messages: [
          { role: 'system', content: SYSTEM_PROMPT },
          ...conversationHistory
        ],
        max_tokens: 8000,
        temperature: 0,
        top_p: 0.9,
        stream: false
      };
      
      try {
        currentAbortController = new AbortController();
        
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${API_KEY}`
          },
          body: JSON.stringify(payload),
          signal: currentAbortController.signal
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
        }
        
        const data = await response.json();
        const botReply = data.choices[0].message.content;
        
        // Add assistant reply to conversation history
        conversationHistory.push({ role: 'assistant', content: botReply });
        
        // Update API status indicator
        apiStatus.innerHTML = '<span style="width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; background-color: white; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.5);"></span> <span>AI Assistant Ready</span>';
        apiStatus.style.background = '#10B981';
        
        return botReply;
      } catch (error) {
        console.error('Error getting AI response:', error);
        
        // Update API status indicator
        apiStatus.innerHTML = '<span style="width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; background-color: white; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.5);"></span> <span>API Connection Error</span>';
        apiStatus.style.background = '#EF4444';
        
        throw error;
      }
    }

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;
      
      // Stop any ongoing typing
      if (currentTypingEffect) {
        stopCurrentTyping();
      }
      
      addMessage(text, "user");
      userInput.value = "";
      userInput.focus();

      const typingIndicator = showTypingIndicator();

      try {
        const botReply = await getAIResponse(text);
        typingIndicator.remove();
        
        addMessageWithTyping(botReply, "bot");
        
        // If voice call is active, speak the response
        if (isVoiceCallActive) {
          speakMessage(botReply);
        }
      } catch (error) {
        console.error("Error:", error);
        typingIndicator.remove();
        
        if (error.name !== 'AbortError') {
          addMessage("Mujhe maaf karna, kuch technical masla ho gaya. Phir se koshish karein.", "bot");
        }
      } finally {
        currentAbortController = null;
      }
    }
    
    // Handle image uploads
    imageUpload.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      // Check if the file is an image
      if (!file.type.match('image.*')) {
        addMessage("Sirf images upload kar sakte hain. Kripya kisi computer science concept ki image select karein.", "bot");
        return;
      }
      
      // Create preview container
      const previewContainer = document.createElement('div');
      previewContainer.className = 'image-preview-container';
      previewContainer.innerHTML = `
        <img src="${URL.createObjectURL(file)}" class="image-preview" alt="Uploaded image">
        <div class="remove-image-btn">
          <span class="material-icons text-red-500">close</span>
        </div>
      `;
      
      // Add preview to chat
      const userBubble = addMessage("Maine ek image upload ki hai", "user");
      userBubble.appendChild(previewContainer);
      
      // Show the preview
      previewContainer.style.display = 'block';
      
      // Add event listener for remove button
      previewContainer.querySelector('.remove-image-btn').addEventListener('click', function() {
        previewContainer.remove();
      });
      
      // Send the image for explanation
      explainImage(file);
    });
    
    // Function to explain uploaded image
    async function explainImage(file) {
      const typingIndicator = showTypingIndicator();
      
      try {
        // Create a prompt for the AI
        const prompt = `Student ne ek computer science concept ki image upload ki hai. Kripya is concept ko Roman Urdu mein step-by-step explain karein. Agar image mein code ho to uski bhi explanation dein.`;
        
        // Get AI response
        const botReply = await getAIResponse(prompt);
        typingIndicator.remove();
        
        // Add the explanation with a special format
        const explanationMessage = `📷 **Image Explanation**\n\n${botReply}`;
        addMessageWithTyping(explanationMessage, "bot");
        
        // If voice call is active, speak the response
        if (isVoiceCallActive) {
          speakMessage(botReply);
        }
      } catch (error) {
        console.error("Error explaining image:", error);
        typingIndicator.remove();
        
        if (error.name !== 'AbortError') {
          addMessage("Image ko explain karne mein masla hua. Phir se koshish karein.", "bot");
        }
      } finally {
        currentAbortController = null;
      }
    }

    // Event listeners
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    
    // Add click handlers to the example prompts
    document.querySelectorAll('.prompt-card').forEach((prompt, index) => {
      prompt.addEventListener('click', () => {
        const prompts = [
          "Variable kya hota hai?",
          "For loop kaise kaam karta hai?",
          "Function kya hota hai?",
          "List kya hoti hai?"
        ];
        userInput.value = prompts[index];
        sendMessage();
      });
    });
    
    // Voice call functionality
    voiceCallBtn.addEventListener('click', () => {
      isVoiceCallActive = !isVoiceCallActive;
      
      if (isVoiceCallActive) {
        voiceCallBtn.classList.add('call-active');
        voiceCallStatus.classList.remove('hidden');
        addMessage("Voice call shuru ho gaya - Ab ap Urdu mein sawal pooch sakte hain", "bot");
      } else {
        voiceCallBtn.classList.remove('call-active');
        voiceCallStatus.classList.add('hidden');
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
        }
        addMessage("Voice call khatam ho gaya", "bot");
      }
    });
    
    // Start chat button handler
    startChatBtn.addEventListener('click', () => {
      userName = userNameInput.value.trim();
      
      if (!userName) {
        alert("Please enter your name to continue");
        return;
      }
      
      // Hide modal and show chat interface
      nameModal.style.display = 'none';
      header.style.display = 'flex';
      chat.style.display = 'block';
      footer.style.display = 'block';
      apiStatus.style.display = 'flex';
      
      // Create welcome cards dynamically
      const welcomeCards = `
        <div class="message-appear flex justify-center mb-8">
          <div class="max-w-6xl w-full text-center">
            <div class="gradient-bg p-1 rounded-full inline-flex mb-4">
              <div class="bg-white p-2 rounded-full">
                <span class="material-icons" style="background: linear-gradient(135deg, #2563EB, #0EA5E9); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">code</span>
              </div>
            </div>
            <h2 class="welcome-title text-2xl font-bold mb-2">Assalam-o-Alaikum ${userName}! Mein PGC Python Tutor 4.2 hoon</h2>
            <p class="welcome-subtitle text-gray-700">Aap ka Python learning assistant. Roman Urdu mein Python programming seekhiye!</p>
            <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3 max-w-md mx-auto">
              <div class="prompt-card rounded-xl p-4 text-sm cursor-pointer">
                <div class="flex items-center">
                  <div class="bg-blue-100 p-1 rounded-lg mr-2">
                    <span class="material-icons text-blue-600 text-sm">code</span>
                  </div>
                  <span class="font-semibold text-gray-800">Variable kya hota hai?</span>
                </div>
              </div>
              <div class="prompt-card rounded-xl p-4 text-sm cursor-pointer">
                <div class="flex items-center">
                  <div class="bg-purple-100 p-1 rounded-lg mr-2">
                    <span class="material-icons text-purple-600 text-sm">loop</span>
                  </div>
                  <span class="font-semibold text-gray-800">For loop kaise kaam karta hai?</span>
                </div>
              </div>
              <div class="prompt-card rounded-xl p-4 text-sm cursor-pointer">
                <div class="flex items-center">
                  <div class="bg-green-100 p-1 rounded-lg mr-2">
                    <span class="material-icons text-green-600 text-sm">functions</span>
                  </div>
                  <span class="font-semibold text-gray-800">Function kya hota hai?</span>
                </div>
              </div>
              <div class="prompt-card rounded-xl p-4 text-sm cursor-pointer">
                <div class="flex items-center">
                  <div class="bg-cyan-100 p-1 rounded-lg mr-2">
                    <span class="material-icons text-cyan-600 text-sm">list</span>
                  </div>
                  <span class="font-semibold text-gray-800">List kya hoti hai?</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      chatContainer.innerHTML = welcomeCards;
      
      // Re-attach event listeners to the newly created prompt cards
      document.querySelectorAll('.prompt-card').forEach((prompt, index) => {
        prompt.addEventListener('click', () => {
          const prompts = [
            "Variable kya hota hai?",
            "For loop kaise kaam karta hai?",
            "Function kya hota hai?",
            "List kya hoti hai?"
          ];
          userInput.value = prompts[index];
          sendMessage();
        });
      });
      
      // Add personalized welcome message
      setTimeout(() => {
        const welcomeMsg = `Assalam-o-Alaikum ${userName}! Mein PGC Python Tutor 4.2 hoon. Roman Urdu mein Python programming sikhane mein aap ki madad karoon ga. Aap kisi bhi computer science concept ki image bhi upload kar sakte hain, main usko Roman Urdu mein explain kar doonga.`;
        addMessageWithTyping(welcomeMsg, "bot");
      }, 1000);
    });
    
    // Focus on input when modal is shown
    userNameInput.focus();
  </script>
</body>
</html>
